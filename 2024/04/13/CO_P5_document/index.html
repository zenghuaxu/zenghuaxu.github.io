<!-- build time:Fri Jul 19 2024 20:11:04 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Zeng HX's Blog" href="https://zenghuaxu.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Zeng HX's Blog" href="https://zenghuaxu.github.io/atom.xml"><link rel="alternate" type="application/json" title="Zeng HX's Blog" href="https://zenghuaxu.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="mips,Verilog HDL,五级流水线CPU"><link rel="canonical" href="https://zenghuaxu.github.io/2024/04/13/CO_P5_document/"><title>CO_P5_document - 计算机组成 | Zeng HX = Zeng HX's Blog</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CO_P5_document</h1><div class="meta"><span class="item" title="创建时间：2024-04-13 23:36:12"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-04-13T23:36:12+08:00">2024-04-13</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>5k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>5 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Zeng HX</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4fomxoj20zk0m8axp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclimtf7dj20zk0m8qav.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclh5u05ej20zk0m87df.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipesrnqv3j20zk0m8ava.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipey84bjtj20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-composition/" itemprop="item" rel="index" title="分类于 计算机组成"><span itemprop="name">计算机组成</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://zenghuaxu.github.io/2024/04/13/CO_P5_document/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Zeng Huaxu"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Zeng HX's Blog"></span><div class="body md" itemprop="articleBody"><h1 id="cpu设计文档及思考题"><a class="anchor" href="#cpu设计文档及思考题">#</a> CPU 设计文档及思考题</h1><h3 id="设计草稿"><a class="anchor" href="#设计草稿">#</a> 设计草稿</h3><h4 id="思路"><a class="anchor" href="#思路">#</a> 思路</h4><ul><li>在单周期 CPU 的基础上，加入流水线寄存器以分割 CPU 的 5 个执行阶段。为了处理冒险，需要加入暂停和转发的模块。为了使得思路更加清晰，先画出流水线 CPU 的设计示意图如下。其中正三角表示转发的供给者，倒三角表示转发的需求者。部分控制信号连线省略了。<br><img data-src="images/28bf9b977c14dacd968f75dcc97f35ba8fd0e0317b2828032c42f7389de474da.png" alt="图 0"></li></ul><h4 id="工程化设计"><a class="anchor" href="#工程化设计">#</a> 工程化设计</h4><ul><li>数据通路的设计如下，其中标记橙色部分为转发的需求者，需要替换为转发需求者多路选择器的输出：<br><img data-src="images/99439b57b3bce70c446879f3debd75a627f33a71dbd14ce8cdc4eef1bf23790a.png" alt="图 1"></li><li>控制信号的设计如下：<br><img data-src="images/608d10bbdd5b4efcdfe8b68fe031b0e75053696d4870a4c6d24f71e42acc6f2a.png" alt="图 2"></li><li>暂停转发的设计如下：<ul><li>暂停 / 转发的策略信号：rs-Tuse,rt-Tuse 是从存到 D 级开始，过多少周期用到。Tnew 是从存入当前寄存器开始，过多少周期更新数据。</li><li>暂停信号例如 (rs-Tuse &lt; Tnew_E &amp;&amp; rs == A3@E &amp;&amp; RegWrite@E &amp;&amp; rs != 0)。其他同理，将两个子公式析取起来得到 rs_Stall，将 rs_Stall 和 rt_Stall 析取得到 Stall。</li><li>转发信号的条件则是信号已经产生并且读写同一个寄存器、寄存器不为零号、写使能。由于采用集中式译码，因此 “信号已经产生” 的条件不是查看后面流水级寄存器得到的 T_new 为零，而是等到将要转发的那个周期中 T_new 为零。即 T_new_2D 为零，T_new_2E 小于等于一，T_new_2M 小于等于 2。</li></ul></li></ul><h4 id="模块设计"><a class="anchor" href="#模块设计">#</a> 模块设计</h4><ul><li><p>PC</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">Clk</td><td style="text-align:center">Input</td><td style="text-align:center">时钟</td></tr><tr><td style="text-align:center">Reset</td><td style="text-align:center">Input</td><td style="text-align:center">同步复位到 0x00003000</td></tr><tr><td style="text-align:center">In</td><td style="text-align:center">Input[31:0]</td><td style="text-align:center">npc</td></tr><tr><td style="text-align:center">Out</td><td style="text-align:center">Output[31:0]</td><td style="text-align:center">pc</td></tr></tbody></table></li><li><p>IM</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">A[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">指令的字节地址</td></tr><tr><td style="text-align:center">Out[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">指令</td></tr></tbody></table></li><li><p>GRF</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">Clk</td><td style="text-align:center">Input</td><td style="text-align:center">时钟</td></tr><tr><td style="text-align:center">Reset</td><td style="text-align:center">Input</td><td style="text-align:center">同步复位</td></tr><tr><td style="text-align:center">WE</td><td style="text-align:center">Input</td><td style="text-align:center">写使能</td></tr><tr><td style="text-align:center">A1[4:0]</td><td style="text-align:center">Input</td><td style="text-align:center">操作数 1 地址</td></tr><tr><td style="text-align:center">A2[4:0]</td><td style="text-align:center">Input</td><td style="text-align:center">操作数 2 地址</td></tr><tr><td style="text-align:center">A3[4:0]</td><td style="text-align:center">Input</td><td style="text-align:center">操作数 3 地址</td></tr><tr><td style="text-align:center">WD[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">写入数据</td></tr><tr><td style="text-align:center">D1[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">读出数据 1</td></tr><tr><td style="text-align:center">D2[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">读出数据 2</td></tr></tbody></table></li><li><p>NPC</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">BLOCK_NPC</td><td style="text-align:center">Input</td><td style="text-align:center">冻结信号</td></tr><tr><td style="text-align:center">NPCMode[2:0]</td><td style="text-align:center">Input</td><td style="text-align:center">运算模式</td></tr><tr><td style="text-align:center">PC_Out[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">F 级 PC</td></tr><tr><td style="text-align:center">PC_D[31;0]</td><td style="text-align:center">Input</td><td style="text-align:center">D 级 PC</td></tr><tr><td style="text-align:center">Imm</td><td style="text-align:center">Input[25:0]</td><td style="text-align:center">25 位立即数</td></tr><tr><td style="text-align:center">ra</td><td style="text-align:center">Input[31:0]</td><td style="text-align:center">ra</td></tr><tr><td style="text-align:center">beq</td><td style="text-align:center">Input</td><td style="text-align:center">beq 两数是否相等</td></tr><tr><td style="text-align:center">pc8</td><td style="text-align:center">Output[31:0]</td><td style="text-align:center">PC_D+8(PC_Out+4)</td></tr><tr><td style="text-align:center">npc</td><td style="text-align:center">Output[31:0]</td><td style="text-align:center">NPC</td></tr></tbody></table></li><li><p>EXT</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">EXTMode[1:0]</td><td style="text-align:center">Input</td><td style="text-align:center">模式</td></tr><tr><td style="text-align:center">Imm16</td><td style="text-align:center">Input</td><td style="text-align:center">待扩展立即数</td></tr><tr><td style="text-align:center">ext[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">结果</td></tr></tbody></table></li><li><p>Controller</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">Opcode[5:0]</td><td style="text-align:center">Input</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">Funct[5:0]</td><td style="text-align:center">Input</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">rs[4:0]</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">rt[4:0]</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">T_new_E[2:0]</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">T_new_D[2:0]</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">T_new_M[2:0]</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">RegWrite_E</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">RegWrite_D</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">RegWrite_M</td><td style="text-align:center" colspan="2">Input</td></tr><tr><td style="text-align:center">NPCMode</td><td style="text-align:center">Output[2:0]</td><td style="text-align:center">NPC 模式</td></tr><tr><td style="text-align:center">EXTMode</td><td style="text-align:center">Output</td><td style="text-align:center">EXT 使能和模式</td></tr><tr><td style="text-align:center">A3Src[1:0]</td><td style="text-align:center">Output</td><td style="text-align:center">ALU/DM 回写</td></tr><tr><td style="text-align:center">ALUSrc[1:0]</td><td style="text-align:center">Output</td><td style="text-align:center">B 为寄存器 / 立即数</td></tr><tr><td style="text-align:center">ALUMode[3:0]</td><td style="text-align:center">Output</td><td style="text-align:center">ALU 模式</td></tr><tr><td style="text-align:center">MemoryWrite</td><td style="text-align:center">Output</td><td style="text-align:center">DM 写使能</td></tr><tr><td style="text-align:center">WDSrc[1:0]</td><td style="text-align:center">Ouput</td><td style="text-align:center">DM 选择</td></tr><tr><td style="text-align:center">RegWrite</td><td style="text-align:center">Output</td><td style="text-align:center">GRF 写使能</td></tr><tr><td style="text-align:center">Stall</td><td style="text-align:center">Output</td><td style="text-align:center">暂停</td></tr><tr><td style="text-align:center">DFV1_DSrc[2:0]</td><td style="text-align:center">Output</td><td style="text-align:center">转发</td></tr><tr><td style="text-align:center">DFV2_DSrc[2:0]</td><td style="text-align:center">Output</td><td style="text-align:center">转发</td></tr><tr><td style="text-align:center">DFV1_ESrc[1:0]</td><td style="text-align:center">Output</td><td style="text-align:center">转发</td></tr><tr><td style="text-align:center">DFV2_ESrc[1:0]</td><td style="text-align:center">Output</td><td style="text-align:center">转发</td></tr><tr><td style="text-align:center">DFData_MSrc[1:0]</td><td style="text-align:center">Output</td><td style="text-align:center">转发</td></tr><tr><td style="text-align:center">T_new_D[2:0]</td><td style="text-align:center">Output</td><td style="text-align:center">产生结果时间</td></tr></tbody></table></li><li><p>ALU</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">A[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">操作数 1</td></tr><tr><td style="text-align:center">B[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">操作数 2</td></tr><tr><td style="text-align:center">ALUMode[3:0]</td><td style="text-align:center">Input</td><td style="text-align:center">模式</td></tr><tr><td style="text-align:center">C[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">运算结果</td></tr></tbody></table></li><li><p>DM</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">Clk</td><td style="text-align:center">Input</td><td style="text-align:center">时钟</td></tr><tr><td style="text-align:center">Reset</td><td style="text-align:center">Input</td><td style="text-align:center">同步复位</td></tr><tr><td style="text-align:center">En</td><td style="text-align:center">Input</td><td style="text-align:center">写使能</td></tr><tr><td style="text-align:center">A[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">读地址</td></tr><tr><td style="text-align:center">WD[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">写数据</td></tr><tr><td style="text-align:center">RD[31:0]</td><td style="text-align:center">Output</td><td style="text-align:center">读出数据</td></tr></tbody></table></li><li><p>D</p><table><thead><tr><th style="text-align:center">信号名</th><th style="text-align:center">方向</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">CLK</td><td style="text-align:center">Input</td><td style="text-align:center">时钟信号</td></tr><tr><td style="text-align:center">Reset</td><td style="text-align:center">Input</td><td style="text-align:center">同步复位</td></tr><tr><td style="text-align:center">BLOCK_D</td><td style="text-align:center">Input</td><td style="text-align:center">冻结信号</td></tr><tr><td style="text-align:center">PC[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">pc</td></tr><tr><td style="text-align:center">IR[31:0]</td><td style="text-align:center">Input</td><td style="text-align:center">指令</td></tr><tr><td style="text-align:center">PC_D</td><td style="text-align:center" colspan="2">Output</td></tr><tr><td style="text-align:center">IR_()_D</td><td style="text-align:center">Ouput</td><td style="text-align:center">指令的各个域</td></tr></tbody></table></li><li><p>E<br><img data-src="images/625d00dca62ad95379426a55da3387f2f4e534f1821a9a46b5c28ea4cbcce0de.png" alt="图 4"><br><img data-src="images/938537a1f935ac242627015e77c733ce509195603354664c31f8c3d6c8f4ba4a.png" alt="图 5"></p></li><li><p>M<br><img data-src="images/f765352219919b11eb3d00f18be6c67bda79a86c95288504d37ad6d8f1da96ef.png" alt="图 6"><br><img data-src="images/7f81613d9762967ba1403084aadfbf47d0db12d68d737cb4128d1812bf5b0031.png" alt="图 7"></p></li><li><p>W<br><img data-src="images/c775f2502faa5fdf8856ade483ee0f89031fedf871c29d5faafbd2922c627ea4.png" alt="图 8"></p></li></ul><h3 id="测试方案"><a class="anchor" href="#测试方案">#</a> 测试方案</h3><ul><li>进行一定的手动测试。其中可以先进行单条指令的测试。这里使用了部分 P3,P4 的测试点。</li><li>多条指令之间的暂停转发的测试。为了进行充分覆盖，将指令分成不同的类型，类型内和类型之间进行测试。包括前一条指令与后一条指令数据相关，隔一条指令数据相关，隔两条指令数据相关。测试样例如下 (算数指令和立即数指令内和之间)：</li></ul><pre><code>.data

.text
  ori $1,$0,12
  ori $2,$0,15
  ori $3,$0,16
  ori $4,$0,17
  add $1,$2,$3
  sub $2,$3,$1
  add $1,$2,$3
  sub $3,$1,$2
  add $1,$2,$3
  nop
  sub $3,$1,$2
  add $1,$2,$3
  nop
  sub $3,$2,$1
  add $1,$2,$3
  nop
  nop
  sub $3,$1,$2
  add $1,$2,$3
  nop
  nop
  sub $3,$2,$1
  add $1,$2,$3
  ori $3,$1,15
  add $1,$2,$3
  nop
  ori $3,$1,13
  add $1,$2,$3
  nop
  nop
  ori $3,$1,15
  add $1,$2,$3
  ori $3,$1,15
  add $1,$3,$2
  ori $3,$1,15
  nop
  add $1,$3,$2
  ori $3,$1,15
  nop
  add $1,$2,$3
  ori $3,$1,15
  nop
  nop
  add $1,$3,$2
  ori $3,$1,15
  nop
  nop
  add $1,$2,$3
  lui $1,0xff
  add $1,$2,$1
  lui $1,0xff
  add $1,$1,$1
  lui $1,0xff
  nop
  add $1,$2,$1
  lui $1,0x1
  nop
  add $2,$1,$2
  lui $1,0x11
  nop
  nop
  add $2,$1,$2
  lui $1,0x1
  nop
  nop
  add $2,$2,$1
</code></pre><h3 id="思考题"><a class="anchor" href="#思考题">#</a> 思考题</h3><ul><li>思考题 1：当分支指令于先前的指令不会产生相关时，能够提高效率，但是如果产生数据相关，很有可能分支指令要被迫暂停等待数据更新。例如：</li></ul><pre><code>lw  $1,0($0)
lw  $2,0($3)
beq $1,$2,label
</code></pre><p>beq 指令要等待两个周期，直到 lw 将要更新的 $2 写入 W 级，才能执行；这和没有提前分支判断（需要等待一个周期）执行完所需要的时钟周期数量是相同的，且不提前判断还可以让延迟槽的指令进入 D 级开始译码。</p><ul><li><p>思考题 2：jal 指令的效果是在 jal 之后所执行的 jr（$ra 未被修改）能够跳转回接下来要执行的指令。由于延迟槽中的指令（即 jal 的 pc+4）已经在跳转前紧随 jr 执行完成，无需也不应该再执行一次，返回时应执行延迟槽的下一条指令，故应该保存 pc+8。</p></li><li><p>思考题 3：如果直接从功能部件进行转发，那么意味着接收者会先计算错误的信号，再计算正确信号。从本周期时钟上升沿开始，接收者接收到正确的输入信号并产生本级结果所经历的组合逻辑延时是提供级和接受级组合逻辑延时之和，这导致如果想要获得稳定正确的输出，则时钟周期被迫延长，这违反了流水线设计的初衷。因此应该在下一周期结果存到流水线寄存器当中再转发。</p></li><li><p>思考题 4：</p><ul><li>这是因为由于流水线执行的特点，存在 GRF 同时被读和被写的冒险的情况，即在某上升沿到来之前，之前在 W 级的指令已经准备好数据和控制信号，而此时在 D 级的信号读出更新前数据，将要存到 E 级流水线寄存器当中。此时 D 级读出的信号并不是我们真正想要的。又因为新信号已经产生并传到 GRF，我们可以通过 GRF 的内部转发把 D 级读出的信号换成新的信号，以解决冒险。</li><li>实现方法：在 GRF 读出数据之前判断是否与将要写入的数据地址相同且不为零，若条件成立，则输出将要写入的值，否则输出寄存器中的值。即：<pre><code>assign RD1 = ((A1 == A3) &amp;&amp; (A1 != 0) &amp;&amp; WE) ? WD : register[A1];
</code></pre></li></ul></li><li><p>思考题 5：</p><ul><li>需求者有 D 级的 GRF.RD1,GRF.RD2，E 级的 V1,V2 以及 M 级的 Data；而供给者有 E 级的 PC8，M 级别的 PC8 和 AO，以及 W 级的要写入的数据 WD。</li><li>假设各个接受方的多路选择器分别是 MFV1_D,MFV2_D,MFV1_E,MFV2_E,MFData_M, 分别对应输出相应的更新数据，而供给方只需要在 M 级有一多路选择器 MFBack_M, 其数据来自 ALUO_M 和 PC8_M。</li><li>转发数据流包括<ul><li>PC8_E-&gt;MFV1_D,</li><li>PC8_E-&gt;MFV2_D,</li><li>MFBack_M-&gt;MFV1_D,</li><li>MFBack_M-&gt;MFV2_D,</li><li>MFBack_M-&gt;MFV1_E,</li><li>MFBack_M-&gt;MFV2_E,</li><li>WD_W-&gt;MFV1_D,</li><li>WD_W-&gt;MFV2_D,</li><li>WD_W-&gt;MFV1_E,</li><li>WD_W-&gt;MFV2_E,</li><li>WD_W-&gt;MFData_M,</li></ul></li></ul></li><li><p>思考题 6：</p><ul><li>指令的分类：目前可以分成如下几类：<ul><li>寄存器算术逻辑运算类型。此类型的运算读两个寄存器，写一个寄存器，使用 ALU 算出结果，不用 Memory。因此 T_use_rs=T_use_rt=1,T_new_D=2。</li><li>寄存器 - 立即数算术逻辑运算类型。此类型的运算读一个个寄存器，用一个立即数，写一个寄存器，使用 ALU 算出结果，不用 Memory。因此 T_use_rs=1,T_new_D=2。</li><li>立即数算术逻辑运算类型。只用立即数算出结果，不用寄存器，T_new=2。</li><li>load 类型。访存。用寄存器，立即数算出地址访问 Mem，修改 rt。T_use_rs=1，T_new_D=3。</li><li>store 类型。T_use_rs=1，不修改寄存器。</li><li>branch 类型。T_use_rs=T_use_rt=0，不修改寄存器。</li><li>立即数 j 类型。不使用寄存器，jal 修改寄存器且 T_new_D=1。</li><li>寄存器 j 类型。T_use_rs=0。</li></ul></li><li>可以看出，在数据通路方面，存在使用寄存器和使用立即数的差别，以及是否经过 ALU 计算的差别，对相应的通路和算术类型，修改控制信号 ALUMode 和 ALUBSrc。</li><li>在暂停转发的控制上，可以将每个指令分成两方面，即读寄存器方面和写寄存器方面。<ul><li>如果不读寄存器，则无暂停转发，在本人设计中即不需要改动 T_use_rs=T_use_rt，设置为默认值。如果需要读寄存器，那么需要把 T_use_rs，T_use_rt 设置到对应值上。这里还需要注意，<strong>可能存在指令使用的寄存器并不是 rs 和 rt 域对应的寄存器，这时候需要修改 D 级的数据通路，通过添加多路选择器将其整合到 rs/rt 中，或者新增加一个流水信号持续下传；同时设置好相应的 T_use_（）值以及 MuxSrc</strong>。</li><li>写寄存器方面。如果不写，对转发暂停无影响，RegWrite 和 T_new 保持默认值即可。如果写，RegWrite 和 T_new 设置到相应值。<strong>同样的，如果写的寄存器不是 rd/rt/0x1f，那么要增加 A3Src 的来源和 A3Src 控制信号。这里特别需要注意的是，A3 不一定在 D 级就已经知道，在这种情况下，需要在后面的流水级多加 MUX 和 MUXSrc 信号，并且如果之后有读寄存器信号，如果 max {T_new_A3,T_new_Data}&gt;T_use, 那么需要暂停。其余需要转发</strong>。</li></ul></li></ul></li><li><p>思考题 7：</p><ul><li>本译码器为集中译码，在 D 级输入 Opcode 和 Funct，译码出指令类型，并以此译码形成模式控制信号，是能控制信号和多路选择器信号（记录每个信号取值对应的指令类型）。同时也输入了 EMW 级的寄存器写使能和 A3 信号，直接在 D 级判断了暂停和转发情况，产生暂停信号或转发选择信号。</li><li>优点是逻辑比较简单，写的代码行数较少；且集中在一个模块内，便于排查错误。不足之处则是需要传递大量的控制信号，流水线寄存器的规模比较大，端口众多且连线复杂，设计时比较麻烦，且不便于添加新的控制信号。</li></ul></li></ul><div class="tags"><a href="/tags/mips/" rel="tag"><i class="ic i-tag"></i> mips</a> <a href="/tags/Verilog-HDL/" rel="tag"><i class="ic i-tag"></i> Verilog HDL</a> <a href="/tags/%E4%BA%94%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BFCPU/" rel="tag"><i class="ic i-tag"></i> 五级流水线CPU</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-04-14 12:42:46" itemprop="dateModified" datetime="2024-04-14T12:42:46+08:00">2024-04-14</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Zeng Huaxu 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Zeng Huaxu 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Zeng Huaxu <i class="ic i-at"><em>@</em></i>Zeng HX's Blog</li><li class="link"><strong>本文链接：</strong> <a href="https://zenghuaxu.github.io/2024/04/13/CO_P5_document/" title="CO_P5_document">https://zenghuaxu.github.io/2024/04/13/CO_P5_document/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/04/13/CO_P4_document/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giph47e9vtj20zk0m8x6l.jpg" title="CO_P4_document"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 计算机组成</span><h3>CO_P4_document</h3></a></div><div class="item right"><a href="/2024/04/13/CO_P6_document/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="CO_P6_document"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 计算机组成</span><h3>CO_P6_document</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#cpu%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3%E5%8F%8A%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">CPU 设计文档及思考题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E8%8D%89%E7%A8%BF"><span class="toc-number">1.0.1.</span> <span class="toc-text">设计草稿</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">工程化设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">模块设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%96%B9%E6%A1%88"><span class="toc-number">1.0.2.</span> <span class="toc-text">测试方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.0.3.</span> <span class="toc-text">思考题</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2024/04/13/CO_P3_document/" rel="bookmark" title="CO_P3_document">CO_P3_document</a></li><li><a href="/2024/04/13/CO_P4_document/" rel="bookmark" title="CO_P4_document">CO_P4_document</a></li><li class="active"><a href="/2024/04/13/CO_P5_document/" rel="bookmark" title="CO_P5_document">CO_P5_document</a></li><li><a href="/2024/04/13/CO_P6_document/" rel="bookmark" title="CO_P6_document">CO_P6_document</a></li><li><a href="/2024/04/13/CO_P7_document/" rel="bookmark" title="CO_P7_document">CO_P7_document</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Zeng Huaxu" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Zeng Huaxu</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">5</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">1</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3plbmdoeFNTUw==" title="https:&#x2F;&#x2F;github.com&#x2F;zenghxSSS"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/04/13/CO_P4_document/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/04/13/CO_P6_document/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-composition/" title="分类于 计算机组成">计算机组成</a></div><span><a href="/2024/04/13/CO_P3_document/" title="CO_P3_document">CO_P3_document</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-composition/" title="分类于 计算机组成">计算机组成</a></div><span><a href="/2024/04/13/CO_P7_document/" title="CO_P7_document">CO_P7_document</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-composition/" title="分类于 计算机组成">计算机组成</a></div><span><a href="/2024/04/13/CO_P5_document/" title="CO_P5_document">CO_P5_document</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-composition/" title="分类于 计算机组成">计算机组成</a></div><span><a href="/2024/04/13/CO_P4_document/" title="CO_P4_document">CO_P4_document</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-composition/" title="分类于 计算机组成">计算机组成</a></div><span><a href="/2024/04/13/CO_P6_document/" title="CO_P6_document">CO_P6_document</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Zeng Huaxu @ Zeng HX</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">24k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">22 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/04/13/CO_P5_document/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdnjs.cloudflare.com/polyfill/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->